<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RHS | Dashboard</title>
  <link rel="stylesheet" href="CSS/dashboard.css" />
  <link rel="shortcut icon" href="../public/IMG/icone.ico" type="image/x-icon" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
  <script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
  <script src="http://www.chartjs.org/samples/latest/utils.js"></script>
  <script src="./js/alerta2.js"></script>
  <style>
    canvas {
      -moz-user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
  </style>
</head>

<!-- <body onload=" atualizarFeed()"> -->

<body>
  <!--  inicio do menu da dashboard  -->
  <div class="meuPopup" id="meuPopup">
    <span id="habitatAlerta"></span>
    <span class="close-popup">x</span>
  </div>
<!--teste-->
  <div class="menu">
    <h1><span style="color: #0f7826">RHS</span>olutions</h1>
    <div class="div_fotouser">
      <img id="img-foto" src="IMG/Dashboard/adicionar-usuario (1).png" alt="" />
    </div>
    <div class="hello">
      <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
      <br />
    </div>

    <span id="menu-separacao">Menu</span>
    <div class="separacao"></div>

    <div class="btn-navbar">
      <div class="flexNavBar">

        <a class="outrasPaginas" href="">
          <img src="IMG/Dashboard/painel-de-controle-verde.png" alt="" />
          Dashboards
        </a>



        <a class="outrasPaginas" href="">
          <img src="IMG/Dashboard/sino.png" alt="" />
          Notificações
        </a>



        <a class="outrasPaginas" href="">
          <img src="IMG/Dashboard/configuracoes.png" alt="" />
          Configurações
        </a>

        <a class="btn-logout" href="HomePage.html">SAIR</a>

      </div>
    </div>
  </div>
  <!-- fim do menu da dashboard -->

  <div class="dash">
    <div class="tituloDash">
      <h1 id="tituloDash"> Dashboard Geral </h1>
      <h1 id="tituloAlt"></h1>
    </div>
    <div id="graftemp" class="div_graficos">
      <div class="div_grafico">
        <span>Análise de Temperatura(22º a 29ºC) nos Habitats</span>
        <canvas id="luminosidade"></canvas>
      </div>
      <div id="graflumi" class="div_grafico">
        <span>Média de Luminosidade(120 a 900) nos Habitats</span>
        <canvas id="lm35Temperatura"></canvas>
      </div>
    </div>
    <div id="temphabi" class="div_graficos" style="display: none;">
      <div class="div_grafico">
        <span>Variação da Luminosidade a cada 6 horas</span>
        <canvas id="luminosidadeHabi"></canvas>
      </div>
      <div id="lumihabi" class="div_grafico" style="display: none;">
        <span>Variação da Temperatura a cada 6 horas</span>
        <canvas id="lm35TemperaturaHabi"></canvas>
      </div>
    </div>
    <section class="section_KPIs">
      <div id="KPI1habi" class="KPIhabi" style="display: none;">
        <span class="spanTitulo2">Habitats em alerta</span>
        <div class="div_KPI2content">
          <span class="spanPorcentagemKPI2" id="span2UltimosAlertas" style="font-size: 25px; margin-top: 20px;"></span>
          <div class="divTextoKPI2" id="divTextoKPI2">
          </div>
        </div>
      </div>
      <div class="div_KPIs">
        <div class="div_KPI" id="KPI1">
          <span class="spanTitulo1"> Quantidade de habitats em alerta</span>
          <div class="div_KPI1content">
            <span class="spanPorcentagemKPI1" id="spanPorcentagemKPI1"></span>
            <div class="divTextoKPI1" id="divTextoKPI1"></div>
          </div>
        </div>
        <div id="KPI2habi" class="KPIhabi" style="display: none;">
          <span class="spanTitulo2" style="height: 100px">Tempetatura atual</span>
          <div class="div_KPI2content">
            <span class="spanPorcentagemKPI2" id="medidasAtuaisTempLumin"> </span>
            <div class="divTextoKPI2">
            </div>
          </div>
        </div>
        <div id="KPI2habi2" class="KPIhabi" style="display: none;">
          <span class="spanTitulo2" style="height: 100px">Luminosidade atual</span>
          <div class="div_KPI2content">
            <span class="spanPorcentagemKPI2" id="medidasAtuaisTempLumin2"> </span>
            <div class="divTextoKPI2">
            </div>
          </div>
        </div>
        <div class="div_KPI" id="KPI2">
          <span class="spanTitulo2"> Ultimo alerta gerado</span>
          <div class="div_KPI2content">
            <span class="spanPorcentagemKPI2" id="spanPorcentagemKPI2"></span>
            <div class="divTextoKPI2">
              <span id="textoKPI"></span>
            </div>

          </div>
        </div>
        <div class="div_KPI" id="KPI3"><span class="spanTitulo3">Média da Temperatura</span>
          <div class="div_KPI3content">
            <div class="divTextoKPI3">
              <img src="./IMG/Dashboard/temperatura-alta.png" alt="">
              <span id="span_media_temp"></span>
            </div>
          </div>
        </div>
        <div class="div_KPI" id="KPI4">
          <span class="spanTitulo4">Média da Luminosidade</span>
          <div class="div_KPI4content">
            <div class="divTextoKPI4">
              <img src="./IMG/Dashboard/temperaturas.png" alt="">
              <span id="span_media_lumi"></span>
            </div>
          </div>
        </div>
      </div>
    </section>
    <div class="search">
      <input type="search" class="search__input" id="input_search" placeholder="Search..." />
      <div class="search__fechar">
        <!-- <img id="limpar_input" src="./IMG/Dashboard/botao-fechar.png" onclick="document.getElementById('input_search').value = '';"> -->
      </div>
      <div class="search__icon">
        <img src="./IMG/Dashboard/lupa.png" />
      </div>
    </div>
    <div class="div_filtro">
      <div class="div_lista">
        <ul id="ul_lista" class="habitat_lista">
          <!-- <li id="li_habitat" class="li_habitat" id="habitat1"><a>Habitat 1</a></li>
          <li id="li_habitat" class="li_habitat" id="habitat2"><a>Habitat 2</a></li>
          <li id="li_habitat" class="li_habitat" id="habitat3"><a>Habitat 3</a></li>
          <li id="li_habitat" class="li_habitat" id="habitat4"><a>Habitat 4</a></li>
          <li id="li_habitat" class="li_habitat" id="habitat5" style="color: red;" onclick="mudarDash()"><a>Habitat
              5</a></li>
          <li id="li_habitat" class="li_habitat" id="habitat6"><a>Habitat 6</a></li>
          <li id="li_habitat" class="li_habitat" id="habitat7"><a>Habitat 7</a></li>
          <li id="li_habitat" class="li_habitat" id="habitat8"><a>Habitat 8</a></li>
          <li id="li_habitat" class="li_habitat" id="habitat9"><a>Habitat 9</a></li>
          <li id="li_habitat" class="li_habitat" id="habitat10"><a>Habitat 10</a></li>
          <li id="li_habitat" class="li_habitat" id="habitat11"><a>Habitat 11</a></li>
          <li id="li_habitat" class="li_habitat" id="habitat12"><a>Habitat 12</a></li>
          <li id="li_habitat" class="li_habitat" id="habitat13"><a>Habitat 13</a></li>
          <li id="li_habitat" class="li_habitat" id="habitat14"><a>Habitat 14</a></li>
          <li id="li_habitat" class="li_habitat" id="habitat15"><a>Habitat 15</a></li>
          <li id="li_habitat" class="li_habitat" id="habitat16"><a>Habitat 16</a></li>
          <li id="li_habitat" class="li_habitat" id="habitat17"><a>Habitat 17</a></li>
          <li id="li_habitat" class="li_habitat" id="habitat18" style="color: red;"><a>Habitat 18</a></li>
          <li id="li_habitat" class="li_habitat" id="habitat19"><a>Habitat 19</a></li>
          <li id="li_habitat" class="li_habitat" id="habitat20"><a>Habitat 20</a></li> -->
        </ul>
        <!-- <select name="empresas" id="listaEmpresas">
          <option value="#">Selecione uma empresa</option>

        </select> -->
      </div>
    </div>
  </div>
</body>
<script>
   obterDadosKPIs()
  validarAlertas()
  listar()
  setInterval(validarAlertas, 5000)
  setInterval(atualizarKPIs, 5000)

  function listar() {
    fetch("/empresas/listarHabitats", {
      method: "GET",
    })
      .then(function (resposta) {
        if (!resposta.ok) {
          throw new Error('Erro ao obter os dados');
        }
        return resposta.json();
      })
      .then(function (empresas) {
        const ulLista = document.getElementById('ul_lista');
        empresas.forEach((empresa) => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          li.className = 'li_habitat';
          a.textContent = 'Habitat ' + empresa.id;
          a.href = '#' + empresa.id;
          a.className = "alistaHabitats"
          a.addEventListener('click', function (event) {
            event.preventDefault(); // Evita o comportamento padrão de seguir o link
            sessionStorage.FK_HABITAT = empresa.id
            mudarDash()
          });
          //Utilizando appendChild para adicionar um nó ao elemento pai (a) e (li)
          li.appendChild(a);
          ulLista.appendChild(li);


        });
      })
      .catch(function (erro) {
        console.error(`#ERRO: ${erro}`);
      });
  }


  // Função para obter os dados
  function obterDadosKPIs() {
    var fk_empresa2 = sessionStorage.FK_EMPRESA;
    var fk_habitat2 = sessionStorage.FK_HABITAT;

    return fetch("/medidas/indicadores", {
      method: "POST",
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        fk_empresa: fk_empresa2,
        fk_habitat: fk_habitat2
      })
    })
      .then(function (resposta) {
        if (!resposta.ok) {
          throw new Error('Erro ao recuperar os dados');
        }
        return resposta.json();
      });
  }

  // Função para atualizar os KPIs em tempo real
  function atualizarKPIs() {
    obterDadosKPIs()
      .then((indicadores) => {
        if (indicadores.length > 0) {
          const mediaTemp = parseFloat(indicadores[0].media_temperatura);
          const mediaLumin = parseFloat(indicadores[0].media_lumin);
          const mediaAtualTemp = indicadores[0].FkLeituraTemp;
          const mediaAtualLumin = indicadores[0].FkLeituraLumi;
          const ultimoAlerta = indicadores[0].ultimo_alerta;
          const qtdHabitatAlerta = indicadores[0].quantidade_habitats_alerta;
          const totalHabitat = indicadores[0].qtd_habitats;
          const porcetagemAlertas = parseFloat(indicadores[0].percentual_habitats_em_alerta);
          const idHabitatAlerta = indicadores[0].ultimo_alertaID;
          const idHabitatAlerta2Ultmos = indicadores[0].ultimo2_alertaID;

          // maior número inteiro
          mediaTemperatura = Math.ceil(mediaTemp);
          mediaLuminocidade = Math.ceil(mediaLumin);
          mediaAtualLumin1 = Math.ceil(mediaAtualLumin);
          mediaAtualTemp1 = Math.ceil(mediaAtualTemp);
          ultimoAlerta1 = ultimoAlerta;
          totalHabitat1 = totalHabitat;
          qtdHabitatAlerta1 = qtdHabitatAlerta;
          porcetagemAlertas1 = Math.abs(porcetagemAlertas);
          idHabitatAlerta1 = idHabitatAlerta;
          idHabitatAlerta2Ultmos1 = idHabitatAlerta2Ultmos;

          console.log(porcetagemAlertas);
        }
        sessionStorage.MEDIA_ATUALTEMP = mediaAtualTemp1;
        sessionStorage.MEDIA_ATUALLUMIN = mediaAtualLumin1;
        sessionStorage.ID_HABITAT_ALERTA = idHabitatAlerta1;
        sessionStorage.DADO_ULTIMO_ALERTA = ultimoAlerta1;

        var mediaTemp = sessionStorage.MEDIA_ATUAL;
        document.getElementById('span_media_temp').innerHTML = `<span>${mediaTemperatura} °C</span>`;
        document.getElementById('span_media_lumi').innerHTML = `<strong><span>${mediaLuminocidade} Lux</span></strong>`;
        document.getElementById('medidasAtuaisTempLumin').innerHTML = `<strong><span>${mediaAtualTemp1}°C </span></strong>`;
        document.getElementById('medidasAtuaisTempLumin2').innerHTML = `<strong><span>${mediaAtualLumin1} Lux</span></strong>`;
        document.getElementById('textoKPI').innerHTML = `<span>${ultimoAlerta1}</span>`;
        document.getElementById('divTextoKPI1').innerHTML = `${qtdHabitatAlerta1}/${totalHabitat1}<strong><span></span></strong>`;
        document.getElementById('spanPorcentagemKPI1').innerHTML = `<strong><span>${porcetagemAlertas1}%</span></strong>`;
        document.getElementById('spanPorcentagemKPI2').innerHTML = `<strong><span>Habitat ${idHabitatAlerta1}</span></strong>`;
        document.getElementById('span2UltimosAlertas').innerHTML = `<strong><span>Habitat ${idHabitatAlerta2Ultmos1}</span></strong>`;
      })
      .catch(function (erro) {
        console.error(`#ERRO: ${erro.message}`);
      });
  }



  const contextoLm35Temperatura = document
    .getElementById("lm35Temperatura")
    .getContext("2d");

  var lm35Temperatura = new Chart(contextoLm35Temperatura, {
    type: "pie",
    data: {
      labels: [
        "Abaixo da média",
        "Na média",
        "Acima da média"
      ],
      datasets: [
        {
          label: "Luminosidade",
          data: [1, 18, 1],
          borderwidht: 1,
          backgroundColor: ["#75b9d7", "#ffd166", "#ff4d4d"],
          borderColor: ["#75b9d7", "#ffd166", "#ff4d4d"]
        },
      ],
    },
    options: {
      scales: {
        xAxes: [
          // {
          //   distribution: "series",
          //   ticks: {
          //     beginAtZero: true,
          //   },
          // },
        ],
        yAxes: [
          // {
          //   scaleLabel: {
          //     display: true,
          //     labelString: "Temperatura",
          //   },
          //   ticks: {
          //     beginAtZero: true,
          //   },
          // },
        ],
      },
      animation: {
        duration: 0,
      },
    },
  });

  // const contextoLuminosidade = document
  //   .getElementById("luminosidade")
  //   .getContext("2d");
  // var luminosidade = new Chart(contextoLuminosidade, {
  //   type: "bar",
  //   data: {
  //     labels: ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho"],
  //     datasets: [
  //       {
  //         label: "Abaixo da média",
  //         data: [7, 12, 8, 7, 2, 8],
  //         borderwidht: 1,
  //         backgroundColor: "#75b9d7",
  //       },
  //       {
  //         label: "Na média",
  //         data: [5, 4, 7, 3, 6, 5],
  //         borderwidht: 1,
  //         backgroundColor: "#ffd166",
  //       },
  //       {
  //         label: "Acima da média",
  //         data: [9, 8, 10, 3, 5, 1],
  //         borderwidht: 1,
  //         backgroundColor: "#ff4d4d",
  //       },
  //     ],
  //   },
  //   options: {
  //     scales: {
  //       xAxes: [
  //         {
  //           distribution: "series",
  //           ticks: {
  //             beginAtZero: true,
  //           },
  //         },
  //       ],
  //       yAxes: [
  //         {
  //           scaleLabel: {
  //             display: true,
  //             labelString: "Quantidade de habitats",
  //           },
  //           ticks: {
  //             beginAtZero: true,
  //           },
  //         },
  //       ],
  //     },
  //     animation: {
  //       duration: 0,
  //     },
  //   },
  // });

  const barraDePesquisa = document.querySelector("input"); //<input/>
  const lista = document.querySelector("ul"); //<ul></ul>
  const itens = document.querySelectorAll("li"); //<li><li/>

  barraDePesquisa.addEventListener("input", () => {
    let valorDigitado = barraDePesquisa.value.toLowerCase();
    itens.forEach((item) => {
      if (item.textContent.toLowerCase().includes(valorDigitado)) {
        item.style.display = "block";
      } else {
        item.style.display = "none";
      }
    });
  });

  // function limpar_input() {
  //     document.getElementById("input_search").value = '' ;
  // }

  function mudarDash() {
    atualizarKPIs();
    tituloAlt.innerHTML = "Habitat 5"
    tituloDash.style.display = 'none'
    KPI1.style.display = 'none'
    KPI2.style.display = 'none'
    KPI3.style.display = 'none'
    KPI4.style.display = 'none'
    graftemp.style.display = 'none'
    graflumi.style.display = 'none'
    temphabi.style.display = 'flex'
    lumihabi.style.display = 'flex'
    KPI1habi.style.display = 'flex'
    KPI2habi.style.display = 'flex'
    KPI2habi2.style.display = 'flex'

    const contextoLm35Temperatura = document
      .getElementById("lm35TemperaturaHabi")
      .getContext("2d");

    var lm35Temperatura = new Chart(contextoLm35Temperatura, {
      type: "line",
      data: {
        labels: ['13H', '14H', '15H', '16H', '17H', '18H'],
        datasets: [{
          label: 'Temperatura',
          data: [22, 29, 21, 24, 14, 23, 31],
          borderwidht: 1,
          fill: false,
          tension: 0.1,
          pointStyle: 'circle',
          backgroundColor: '#ffd166',
          borderColor: '#ffd166'
        },
        ],
      },
      options: {
        scales: {
          xAxes: [
            {
              distribution: "series",
              ticks: {
                beginAtZero: true,
              },
            },
          ],
          yAxes: [
            {
              scaleLabel: {
                display: true,
                labelString: "Temperatura",
              },
              ticks: {
                beginAtZero: true,
              },
            },
          ],
        },
        animation: {
          duration: 0,
        },
      },
    });

    // const contextoLuminosidade = document
    //   .getElementById("luminosidadeHabi")
    //   .getContext("2d");
    // var luminosidade = new Chart(contextoLuminosidade, {
    //   type: "bar",
    //   data: {
    //     labels: ["13H", "14H", "15H", "16H", "17H", "18H"],
    //     datasets: [
    //       {
    //         label: "Luminosidade",
    //         data: [702, 754, 810, 520, 793, 831],
    //         borderwidht: 1,
    //         backgroundColor: "#75b9d7"
    //       },
    //     ],
    //   },
    //   options: {
    //     scales: {
    //       xAxes: [
    //         {
    //           distribution: "series",
    //           ticks: {
    //             beginAtZero: true,
    //           },
    //         },
    //       ],
    //       yAxes: [
    //         {
    //           scaleLabel: {
    //             display: true,
    //             labelString: "Luminosidade",
    //           },
    //           ticks: {
    //             beginAtZero: true,
    //           },
    //         },
    //       ],
    //     },
    //     animation: {
    //       duration: 0,
    //     },
    //   },
    // });

    let graficoBarLuminVariacao;
    function obterDadosGraficoBarLumin() {
      var fk_empresa = sessionStorage.FK_EMPRESA;

      fetch(`/medidas/buscarResultadoGraficoBarLumin/${fk_empresa}`, {
        method: "GET"
      }).then(function (resposta) {
        if (resposta.ok) {
          return resposta.json();
          graficoLuminVariacao.update();
          ;
        } else {

          console.log("Houve um erro ao tentar realizar a busca!");
        }

      })
        .then(function (data) {
          if (data.length === 0) {
            console.warn("Nenhum resultado encontrado");
            return;
          }

          atualizarGraficoBarLumin(data);
        })
        .catch(function (erro) {
          console.log(erro);
        })

      return false;
    }

    function atualizarGraficoBarLumin(dados) {
      console.log("Dados recebidos para o gráfico de Barra:", dados);

      const ctx = document.getElementById(`luminosidadeHabi`);

      if (graficoBarLuminVariacao) {
        graficoBarLuminVariacao.destroy();
      }

      const duvidasPassos = Object.values(dados[0]).map(Number);
      const passos = ["13H"];

      graficoBarLuminVariacao = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ["13H"],
          datasets: [{
            label: 'luminocidade',
            data: duvidasPassos,

            backgroundColor:
              '#fd2828'
            ,
            borderColor: '#fd2828',
            tension: 0.1
          }]
        },
        responsive: true,
        options: {
          responsive: true,
          animation: false,
          plugins: {
            legend: {
              labels: {
                color: 'black'
              }
            },
            y: {
              ticks: {
                color: 'black'
              }
            }
          }
        }
      });
    }


    obterDadosGraficoBarLumin();
    setInterval(atualizarGraficoBarLumin, 5000);
  }
  let graficoBar;
  function obterDadosGraficoBar() {
    fetch(`/medidas/buscarResultadoGraficoBar/${sessionStorage.FK_EMPRESA}`, {
      method: "GET"
    }).then(function (resposta) {
      if (resposta.ok) {
        return resposta.json();
        graficoBar.update();
        ;
      } else {

        console.log("Houve um erro ao tentar realizar a busca!");
      }

    })
      .then(function (data) {
        if (data.length === 0) {
          console.warn("Nenhum resultado encontrado");
          return;
        }

        atualizarGraficoBar(data);
      })
      .catch(function (erro) {
        console.log(erro);
      })

    return false;
  }

  function atualizarGraficoBar(dados) {
    console.log("Dados recebidos para o gráfico de Barra:", dados);

    const ctx = document.getElementById('luminosidade');

    if (graficoBar) {
      graficoBar.destroy();
    }

    const passos = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho'];

    // Inicializamos os arrays para cada faixa de temperatura com zeros
    const abaixoDaMedia = [0, 0, 0, 0, 0, 0];
    const naMedia = [0, 0, 0, 0, 0, 0];
    const acimaDaMedia = [0, 0, 0, 0, 0, 0];

    if (dados[0]) {
      if (dados[0].MediaAbaixo22 !== undefined) {
        abaixoDaMedia[5] = dados[0].MediaAbaixo22;
      }
      if (dados[0].MediaEntre22e29 !== undefined) {
        naMedia[5] = dados[0].MediaEntre22e29;
      }
      if (dados[0].MediaAcima29 !== undefined) {
        acimaDaMedia[5] = dados[0].MediaAcima29;
      }
    }

    graficoBar = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: passos,
        datasets: [
          {
            label: 'Abaixo da Média',
            data: abaixoDaMedia,
            backgroundColor: "#75b9d7",
            borderWidth: 1,
            tension: 0.1
          },
          {
            label: "Na média",
            data: naMedia,
            borderWidth: 1,
            backgroundColor: "#ffd166"
          },
          {
            label: "Acima da média",
            data: acimaDaMedia,
            borderWidth: 1,
            backgroundColor: '#fd2828'
          }
        ]
      },
      responsive: true,
      options: {
        responsive: true,
        animation: false,
        plugins: {
          legend: {
            labels: {
              color: 'black'
            }
          },
          y: {
            ticks: {
              color: 'black'
            }
          }
        }
      }
    });
  }

  obterDadosGraficoBar();
  setInterval(obterDadosGraficoBar, 100000);




</script>

</html>